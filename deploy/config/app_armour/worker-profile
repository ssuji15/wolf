#include <tunables/global>


profile worker flags=(attach_disconnected,mediate_deleted) {

  ## ---------------------------------------------------------------------
  ## Default deny everything
  ## ---------------------------------------------------------------------
  #deny /** rwklxm,

  ## ---------------------------------------------------------------------
  ## Allow container binaries and libraries
  ## ---------------------------------------------------------------------
  /bin/**                  rix,
  /usr/bin/**              rix,
  /usr/local/bin/**        rix,
  /sbin/**                 rix,
  /usr/sbin/**             rix,
  /lib/**                  rix,
  /lib64/**                rix,
  /usr/lib/**              rix,
  /usr/lib64/**            rix,

  ## Allow JVM and compilers
  /usr/lib/jvm/**          rix,
  /usr/bin/gcc             rix,
  /usr/bin/g++             rix,
  /usr/bin/cc              rix,
  /usr/bin/c++             rix,
  /usr/bin/go              rix,
  /usr/bin/javac           rix,
  /usr/bin/java            rix,

  ## ---------------------------------------------------------------------
  ## Only /job accessible for user code (read/write/execute)
  ## ---------------------------------------------------------------------
  /job/**                  rwklix,
  
  /tmp/**                  rwklix,
  /usr/include/**          rix,
  /var/tmp/** rwklix,
  /dev/null                rw,
  /dev/urandom             r,
  /dev/zero                r,
  /dev/random              r,

  ## ---------------------------------------------------------------------
  ## Unix domain sockets for gRPC
  ## ---------------------------------------------------------------------
  unix,
  deny network inet,
  deny network inet6,


  ## ---------------------------------------------------------------------
  ## Prevent execution of shells or scripting interpreters
  ## ---------------------------------------------------------------------
  deny /bin/sh              x,
  deny /bin/bash            x,
  deny /usr/bin/env          x,
  deny /usr/bin/sudo         x,
  deny /usr/bin/pkexec       x,
  deny /bin/dash             x,
  deny /bin/zsh              x,
  deny /usr/bin/perl          x,
  deny /usr/bin/python*       x,

  ## ---------------------------------------------------------------------
  ## Allow essential /proc reads for runtime
  ## ---------------------------------------------------------------------
  /proc/cpuinfo            r,
  /proc/meminfo            r,
  /proc/self/**            r,

  ## Block sensitive proc and sysfs paths
  deny /proc/kcore         r,
  deny /proc/keys          r,
  deny /proc/timer_list    r,
  deny /proc/sysrq-trigger rw,
  deny /sys/**             rw,
  deny /proc/sys/**        rw,

  ## ---------------------------------------------------------------------
  ## Capabilities
  ## ---------------------------------------------------------------------
  capability chown,
  capability dac_override,
  capability fowner,
  capability fsetid,
  capability setgid,
  capability setuid,
  
  ## Allow container runtime to signal the task
  signal (receive) peer=unconfined,

  # Dangerous capabilities denied
  deny capability sys_admin,
  deny capability sys_module,
  deny capability sys_time,
  deny capability sys_nice,
  deny capability mknod,
  deny capability sys_rawio,
  deny capability audit_control,
}
